import { test, expect } from '@playwright/test';

test.describe('Authentication Page Tests with Real API', () => {
    const appUrl = 'http://103.251.252.106:31823/'; // Replace with your app URL
    const apiBaseUrl = 'http://103.251.252.106:31823'; // Replace with your API base URL
    const validUser = { email: 'user@example.com', password: 'password123' };

    test.beforeEach(async ({ page }) => {
        await page.goto(appUrl);
    });

    test.describe('UI Element Visibility', () => {
        test('Verify email input field is visible', async ({ page }) => {
            const emailInput = page.locator('#email');
            await expect(emailInput).toBeVisible();
        });

        test('Verify password input field is visible', async ({ page }) => {
            const passwordInput = page.locator('#password');
            await expect(passwordInput).toBeVisible();
        });

        test('Verify Sign In button is visible', async ({ page }) => {
            const signInButton = page.locator('#signInButton');
            await expect(signInButton).toBeVisible();
        });

        test('Verify Sign Up button is visible', async ({ page }) => {
            const signUpButton = page.locator('#signUpButton');
            await expect(signUpButton).toBeVisible();
        });
    });

    test.describe('Authentication Functionality with Real API', () => {
        test('Sign In with valid credentials should redirect', async ({ page }) => {
            // Fill the form fields
            await page.fill('#email', validUser.email);
            await page.fill('#password', validUser.password);

            // Click the Sign In button
            await page.click('#signInButton');

            // Wait for API response and verify localStorage
            await page.waitForFunction(() => localStorage.getItem('authToken') !== null);

            const token = await page.evaluate(() => localStorage.getItem('authToken'));
            expect(token).not.toBeNull();

            // Validate redirection
            await page.waitForURL(/test.html/);
            expect(page.url()).toContain('test.html');
        });

        test('Sign Up with valid credentials should redirect', async ({ page }) => {
            const newEmail = `newuser_${Date.now()}@example.com`; // Unique email for each run

            // Fill the form fields
            await page.fill('#email', newEmail);
            await page.fill('#password', validUser.password);

            // Click the Sign Up button
            await page.click('#signUpButton');

            // Wait for API response
            const successMessage = await page.waitForSelector('text=Registration successful');
            await expect(successMessage).toBeVisible();

            // Validate redirection
            await page.waitForURL(/test.html/);
            expect(page.url()).toContain('test.html');
        });

        test('Sign In with incorrect credentials should show error alert', async ({ page }) => {
            // Fill the form fields with incorrect credentials
            await page.fill('#email', 'wrong@example.com');
            await page.fill('#password', 'wrongpassword');

            // Click the Sign In button
            await page.click('#signInButton');

            // Validate error alert
            const alert = await page.locator('text=Sign In Error: Invalid credentials');
            await expect(alert).toBeVisible();
        });

        test('Sign Up with existing email should show error alert', async ({ page }) => {
            // Fill the form fields with an existing email
            await page.fill('#email', validUser.email);
            await page.fill('#password', validUser.password);

            // Click the Sign Up button
            await page.click('#signUpButton');

            // Validate error alert
            const alert = await page.locator('text=Email already exists');
            await expect(alert).toBeVisible();
        });

        test('Sign In with empty fields should show alert', async ({ page }) => {
            // Leave fields empty and click the Sign In button
            await page.click('#signInButton');

            // Validate alert for empty fields
            const alert = await page.locator('text=Please fill in all fields.');
            await expect(alert).toBeVisible();
        });

        test('Sign Up with empty fields should show alert', async ({ page }) => {
            // Leave fields empty and click the Sign Up button
            await page.click('#signUpButton');

            // Validate alert for empty fields
            const alert = await page.locator('text=Please fill in all fields.');
            await expect(alert).toBeVisible();
        });
    });
});
